!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).FHIRAuth=f()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n||e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_util2=function(obj){return obj&&obj.__esModule?obj:{default:obj}}(require("./util")),Flow=function(){function Flow(){_classCallCheck(this,Flow)}return _createClass(Flow,[{key:"token",value:function(hash){return hash||(hash=window.location.hash),Promise(function(resolve,reject){var oauthResult=hash.match(/#(.*)/);oauthResult=(oauthResult=oauthResult?oauthResult[1]:"").split(/&/);for(var authorization={},i=0;i<oauthResult.length;i++){var kv=oauthResult[i].split(/=/);kv[0].length>0&&kv[1]&&(authorization[decodeURIComponent(kv[0])]=decodeURIComponent(kv[1]))}resolve(authorization)})}},{key:"code",value:function(params){params||(params={code:_util2.default.getParam("code"),state:_util2.default.getParam("state")});var state=JSON.parse(sessionStorage[params.state]);if(window.history.pushState){var queryParam=window.location.search;if(-1===window.location.search.indexOf("state")){queryParam+=window.location.search?"&":"?",queryParam+="state="+params.state;var url=window.location.protocol+"//"+window.location.host+window.location.pathname+queryParam;window.history.pushState({},"",url)}}var data={code:params.code,grant_type:"authorization_code",redirect_uri:state.client.redirect_uri};return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;state.client.tokenOverride?(xhr.open("POST",window.location.protocol+"//"+window.location.host+"/token"),data.token_uri=state.provider.oauth2.token_uri):xhr.open("POST",state.provider.oauth2.token_uri),state.client.secret?xhr.setRequestHeader("Authorization","Basic "+btoa(state.client.client_id+":"+state.client.secret)):data.client_id=state.client.client_id,xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.onload=function(){this.status>=200&&this.status<300?resolve(_util2.default.extend(JSON.parse(xhr.response),params)):reject(_util2.default.toXHRError(xhr))},xhr.onerror=function(){reject(_util2.default.toXHRError(xhr))},xhr.send(_util2.default.toURLEncoded(data))})}}]),Flow}();exports.default=new Flow},{"./util":8}],2:[function(require,module,exports){(function(process){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function getPreviousToken(){var state=_util2.default.getParam("state");if(sessionStorage[state])return JSON.parse(sessionStorage[state]).tokenResponse}function completePageReload(){return new _promisePolyfill2.default(function(resolve,reject){process.nextTick(function(){var token=getPreviousToken();if(isTokenExpired(token))return refreshToken().then(function(result){resolve(result)}).catch(function(err){reject(err)});resolve(token)})})}function isTokenExpired(tr){return!tr.expiratonDateTime||new Date(tr.expiratonDateTime)<new Date}function refreshToken(){var state=_util2.default.getParam("state");return _token2.default.refresh(JSON.parse(sessionStorage[state]))}function readyArgs(){var input=null,callback=function(){},errback=function(){};if(0===arguments.length)throw new Error("Cannot call ready without arguments");if(1===arguments.length)callback=arguments[0];else if(2===arguments.length)if("function"==typeof arguments[0])callback=arguments[0],errback=arguments[1];else{if("object"!==_typeof(arguments[0]))throw new Error("ready called with invalid arguments");input=arguments[0],callback=arguments[1]}else{if(3!==arguments.length)throw new Error("ready called with invalid arguments");input=arguments[0],callback=arguments[1],errback=arguments[2]}return{input:input,callback:callback,errback:errback}}function validTokenResponse(){var args=arguments,state=_util2.default.getParam("state")||args.input&&args.input.state;return state&&sessionStorage[state]&&void 0!==JSON.parse(sessionStorage[state]).tokenResponse}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_promisePolyfill2=_interopRequireDefault(require("promise-polyfill")),_flow2=_interopRequireDefault(require("./flow")),_smart2=_interopRequireDefault(require("./smart")),_jwt2=_interopRequireDefault(require("./jwt")),_util2=_interopRequireDefault(require("./util")),_token2=_interopRequireDefault(require("./token"));module.exports={ready:function(){var args=readyArgs.apply(this,arguments),isCode=_util2.default.getParam("code")||args.input&&args.input.code;(validTokenResponse()?completePageReload():isCode?_flow2.default.code(args.input):_flow2.default.token(args.input)).then(function(tokenResponse){if(!tokenResponse||!tokenResponse.state)return args.errback("No state parameter found in authorization response.");if(!tokenResponse.expiratonDateTime){var t=new Date;tokenResponse.expiratonDateTime=t.setSeconds(t.getSeconds()+Number(tokenResponse.expires_in))}sessionStorage[tokenResponse.state]=JSON.stringify(_util2.default.extend(JSON.parse(sessionStorage[tokenResponse.state]),{tokenResponse:tokenResponse}));var state=JSON.parse(sessionStorage[tokenResponse.state]);state.fake_token_response&&(tokenResponse=state.fake_token_response);var fhirClientParams={serviceUrl:state.provider.url,patientId:tokenResponse.patient};if(tokenResponse.id_token){var id_token=tokenResponse.id_token,payload=_jwt2.default.decode(id_token);fhirClientParams.userId=payload.profile}if(tokenResponse.access_token)fhirClientParams.auth={type:"bearer",token:tokenResponse.access_token};else if(!state.fake_token_response)return args.errback("Failed to obtain access token.");var smart=new _smart2.default(fhirClientParams);smart.state=JSON.parse(JSON.stringify(state)),smart.tokenResponse=JSON.parse(JSON.stringify(tokenResponse)),args.callback(smart)}).catch(function(err){args.errback(err)})}},window.Promise||(window.Promise=_promisePolyfill2.default)}).call(this,require("_process"))},{"./flow":1,"./jwt":3,"./smart":6,"./token":7,"./util":8,_process:4,"promise-polyfill":5}],3:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),JWT=function(){function JWT(){_classCallCheck(this,JWT)}return _createClass(JWT,[{key:"decode",value:function(token){var base64=token.split(".")[1].replace("-","+").replace("_","/");return JSON.parse(window.atob(base64))}}]),JWT}();exports.default=new JWT},{}],4:[function(require,module,exports){function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(fun){if(cachedSetTimeout===setTimeout)return setTimeout(fun,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(fun,0);try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout)return clearTimeout(marker);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(marker);try{return cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var timeout=runTimeout(cleanUpNextTick);draining=!0;for(var len=queue.length;len;){for(currentQueue=queue,queue=[];++queueIndex<len;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,draining=!1,runClearTimeout(timeout)}}function Item(fun,array){this.fun=fun,this.array=array}function noop(){}var cachedSetTimeout,cachedClearTimeout,process=module.exports={};!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var currentQueue,queue=[],draining=!1,queueIndex=-1;process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(fun,args)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(name){return[]},process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")},process.umask=function(){return 0}},{}],5:[function(require,module,exports){!function(root){function noop(){}function bind(fn,thisArg){return function(){fn.apply(thisArg,arguments)}}function Promise(fn){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof fn)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],doResolve(fn,this)}function handle(self,deferred){for(;3===self._state;)self=self._value;0!==self._state?(self._handled=!0,Promise._immediateFn(function(){var cb=1===self._state?deferred.onFulfilled:deferred.onRejected;if(null!==cb){var ret;try{ret=cb(self._value)}catch(e){return void reject(deferred.promise,e)}resolve(deferred.promise,ret)}else(1===self._state?resolve:reject)(deferred.promise,self._value)})):self._deferreds.push(deferred)}function resolve(self,newValue){try{if(newValue===self)throw new TypeError("A promise cannot be resolved with itself.");if(newValue&&("object"==typeof newValue||"function"==typeof newValue)){var then=newValue.then;if(newValue instanceof Promise)return self._state=3,self._value=newValue,void finale(self);if("function"==typeof then)return void doResolve(bind(then,newValue),self)}self._state=1,self._value=newValue,finale(self)}catch(e){reject(self,e)}}function reject(self,newValue){self._state=2,self._value=newValue,finale(self)}function finale(self){2===self._state&&0===self._deferreds.length&&Promise._immediateFn(function(){self._handled||Promise._unhandledRejectionFn(self._value)});for(var i=0,len=self._deferreds.length;i<len;i++)handle(self,self._deferreds[i]);self._deferreds=null}function Handler(onFulfilled,onRejected,promise){this.onFulfilled="function"==typeof onFulfilled?onFulfilled:null,this.onRejected="function"==typeof onRejected?onRejected:null,this.promise=promise}function doResolve(fn,self){var done=!1;try{fn(function(value){done||(done=!0,resolve(self,value))},function(reason){done||(done=!0,reject(self,reason))})}catch(ex){if(done)return;done=!0,reject(self,ex)}}var setTimeoutFunc=setTimeout;Promise.prototype.catch=function(onRejected){return this.then(null,onRejected)},Promise.prototype.then=function(onFulfilled,onRejected){var prom=new this.constructor(noop);return handle(this,new Handler(onFulfilled,onRejected,prom)),prom},Promise.all=function(arr){var args=Array.prototype.slice.call(arr);return new Promise(function(resolve,reject){function res(i,val){try{if(val&&("object"==typeof val||"function"==typeof val)){var then=val.then;if("function"==typeof then)return void then.call(val,function(val){res(i,val)},reject)}args[i]=val,0==--remaining&&resolve(args)}catch(ex){reject(ex)}}if(0===args.length)return resolve([]);for(var remaining=args.length,i=0;i<args.length;i++)res(i,args[i])})},Promise.resolve=function(value){return value&&"object"==typeof value&&value.constructor===Promise?value:new Promise(function(resolve){resolve(value)})},Promise.reject=function(value){return new Promise(function(resolve,reject){reject(value)})},Promise.race=function(values){return new Promise(function(resolve,reject){for(var i=0,len=values.length;i<len;i++)values[i].then(resolve,reject)})},Promise._immediateFn="function"==typeof setImmediate&&function(fn){setImmediate(fn)}||function(fn){setTimeoutFunc(fn,0)},Promise._unhandledRejectionFn=function(err){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",err)},Promise._setImmediateFn=function(fn){Promise._immediateFn=fn},Promise._setUnhandledRejectionFn=function(fn){Promise._unhandledRejectionFn=fn},void 0!==module&&module.exports?module.exports=Promise:root.Promise||(root.Promise=Promise)}(this)},{}],6:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});exports.default=function Smart(p){_classCallCheck(this,Smart),this.userId=p.userId,p.patientId&&(this.patient={},this.patient.id=p.patientId),this.user={read:function(){var userId=this.userId,resource=userId.split("/")[0],uid=userId.split("/")[1];return this.get({resource:resource,id:uid})}};var server=this.server={serviceUrl:p.serviceUrl,auth:p.auth||{type:"none"}};if(server.auth=server.auth||{type:"none"},!this.server.serviceUrl||!this.server.serviceUrl.match(/https?:\/\/.+[^/]$/))throw new Error("Must supply a `server` property whose `serviceUrl` begins with http(s) and does NOT include a trailing slash. E.g. `https://fhir.aws.af.cm/fhir`")}},{}],7:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_util2=function(obj){return obj&&obj.__esModule?obj:{default:obj}}(require("./util")),Token=function(){function Token(){_classCallCheck(this,Token)}return _createClass(Token,[{key:"refresh",value:function(state){var data={grant_type:"refresh_token",refresh_token:state.tokenResponse.refresh_token};return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;xhr.open("POST",state.provider.oauth2.token_uri),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.setRequestHeader("Accept","application/json"),xhr.onload=function(){if(this.status>=200&&this.status<300){var oldState=state.tokenResponse.state,oldCode=state.tokenResponse.code,refreshToken=state.tokenResponse.refresh_token,newToken=JSON.parse(xhr.response);newToken.state=oldState,newToken.code=oldCode,newToken.refresh_token=refreshToken,resolve(newToken)}else reject(_util2.default.toXHRError(this))},xhr.onerror=function(){reject(new Error("Refresh Token failed"))},xhr.send(_util2.default.toURLEncoded(data))})}}]),Token}();exports.default=new Token},{"./util":8}],8:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),Util=function(){function Util(){_classCallCheck(this,Util)}return _createClass(Util,[{key:"getParam",value:function(p){for(var data=location.search.substr(1).split("&"),result=[],i=0;i<data.length;i++){var item=data[i].split("=");if(item[0]===p){var res=item[1].replace(/\+/g,"%20");result.push(decodeURIComponent(res))}}if(result.length)return result[0]}},{key:"extend",value:function(a,b){for(var key in b)b.hasOwnProperty(key)&&(a[key]=b[key]);return a}},{key:"toURLEncoded",value:function(element,key,list){if(list=list||[],"object"===(void 0===element?"undefined":_typeof(element)))for(var idx in element)this.toURLEncoded(element[idx],key?key+"[ "+idx+"]":idx,list);else list.push(key+"="+encodeURIComponent(element));return list.join("&")}},{key:"toXHRError",value:function(xhr){return new Error({status:xhr.status,statusText:xhr.statusText})}}]),Util}();exports.default=new Util},{}]},{},[2])(2)});
